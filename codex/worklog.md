# Worklog — Marble Muse

## Format
Each entry: `[DATE] [AGENT/HUMAN] [TASK_ID] — Summary of work done`

---

<!-- Entries will be added here as work progresses -->
[2026-02-27] [AGENT] [T01,T02,T03] — Completed foundation scaffold + Spark viewer + SplatEdit spike wiring. Added `src/main.ts`, finalized `src/viewer.ts` (camera fit from bounding box, SparkRenderer, OrbitControls, click raycast with wireframe indicator, screenshot helper, callback unsubscribe), copied Marble test scene to `public/scenes/elegant_library_with_fireplace_500k.spz`, and added hardcoded delete/recolor/additive `SplatEdit` spike tests with softEdge + timed removal/restore log. `npm run build` passes. `npm run dev` could not be runtime-verified in this environment because sandbox blocks opening a local listening port (`listen EPERM`). 
[2026-02-27] [AGENT] [TESTS] — Started unit test suite by extracting spike helper math/formatting into `src/spike-utils.ts` and adding `tests/spike-utils.test.ts` (fallback anchor behavior, bounds-derived anchor placement, radius clamping, point formatting). Added `vitest` scripts/dependency to `package.json` (dependency install/runtime not verified in sandbox).
[2026-02-27] [AGENT] [T05,T06] — Added `src/types.ts` with shared interfaces (VoxelCell/SpatialGrid/SceneManifest/EditOperation/etc.) and implemented `src/spatial-index.ts` (20x20x20 voxel grid build from `SplatMesh.forEachSplat()`, Y-crop fallback, per-cell stats, queries, LLM serialization). Wired minimal spatial index logging into `src/main.ts` and added `tests/spatial-index.test.ts` for crop/grid mapping/query/serialization helpers. `npm run build` passes. `npm test` currently fails (`vitest: not found`) because `npm install` cannot fetch registry in this environment (`EAI_AGAIN`).
[2026-02-27] [AGENT] [UX] — Added keyboard movement to `src/viewer.ts`: WASD horizontal movement, Q/E vertical movement, and Shift speed boost. Movement translates both `camera.position` and `OrbitControls.target` each frame so OrbitControls remains usable while navigating the scene. `npm run build` passes.
[2026-02-28] [AGENT] [T07] — Implemented `src/agent.ts` Claude command pipeline with a high-precision Spark SDF system prompt, multimodal request assembly, Anthropic Sonnet API wrapper (`anthropic-dangerous-direct-browser-access` header, temperature 0), markdown/JSON parsing fallback, strict runtime operation/shape validation + normalization, and single-retry error handling. Added `buildClickContext()` with compact click/primary-cell/neighbor summaries. Enforced delete safety defaults (`extractAsset: true`, generated `assetLabel` fallback). Logged outcomes/errors with `[agent]` prefix and included command/op counts. Saved full prompt verbatim to `codex/agent-system-prompt.md`.
[2026-02-28] [AGENT] [T07-TEST/HARDEN] — Hardened `src/agent.ts` and added `tests/agent.test.ts` (8 tests) covering: system prompt presence checks, `buildClickContext()` formatting, raw JSON parsing, markdown-wrapped JSON parsing, retry-then-success behavior, retry exhaustion failures, Anthropic header/body correctness, and delete normalization behavior. Hardening changes include screenshot base64 normalization (supports `data:image/...;base64,...`), action→blend canonicalization safety, and forced `opacity: 0` for delete shapes. Full suite now passes (`npm test`: 20/20 tests, `npm run build` passes).
[2026-02-27] [AGENT] [T05,T06,T10] — Finalized data layer: (1) Verified `src/types.ts` has all 7 AGENTS.md interfaces complete. (2) Improved `src/spatial-index.ts`: added default `radius=1` to `getNeighborCells`, improved `serializeSpatialGridForLLM` to skip cells with <10 splats, round to 2 decimals, use hex color strings, include cell dimensions, use compact JSON keys for smaller payload. (3) Created `src/scene-manifest.ts` with color/height heuristic labeling (sky, vegetation, ground, structure, shadow, etc.), 6-connected flood-fill connected-component grouping into `SemanticRegion` objects, natural language description generation, and `getManifestJSON` for compact serialization. (4) Updated `src/main.ts` to call `generateManifest()` after `buildSpatialGrid()`, log manifest description/region count, and store grid+manifest in module-level state with exported getters for future modules. `npm run build` passes cleanly (tsc + vite). Runtime timing and cell count stats pending browser verification.
[2026-02-28] [AGENT] [T08,T09] — Implemented end-to-end edit pipeline wiring for MVP. Added `src/executor.ts` with full `EditOperation[]` -> Spark `SplatEdit`/`SplatEditSdf` translation, explicit blend/type enum mapping, conditional shape field assignment (including optional opacity handling), scoped-vs-global parent heuristic (`atmosphere` and `light+ALL`), and undo stack APIs (`undoLastEdit`, `undoAllEdits`, `getEditHistory`) with optional disposal. Added `src/ui.ts` chat interface (`#muse-chat-container`) with message log, status text, send and undo controls, toast notifications, Enter send, Ctrl/Cmd+Z undo, and full runtime pipeline integration (`processCommand` + click/grid/manifest/screenshot context + `executeOperations`). Refactored `src/main.ts` to remove all T03 spike edit code/imports, keep viewer->spatial->manifest bootstrap, track/export module-level `lastClickPoint`, and initialize UI via dependency injection. Updated `src/styles.css` with chat/toast styles while preserving existing `#canvas` and `#info`. Validation: `npm run build` passes and `npm test` passes (67/67).
[2026-02-28] [AGENT] [T08,T09-HARDEN] — Hardened MVP integration against spec details: updated `src/executor.ts` to use safer SDF color/displace assignment and robust scene-ancestor resolution for global operations (atmosphere / light+ALL). Updated `src/ui.ts` to remove input-focused Ctrl/Cmd+Z bypass (undo now consistently maps to edit undo), normalize screenshot payload before calling agent, and clean unused imports. Re-validated with `npm run build` and `npm test` (all passing).
[2026-02-28] [AGENT] [GEMINI-MIGRATION] — Migrated command pipeline from Anthropic Claude to Google Gemini Flash 3 (`gemini-3-flash-preview`) via official `@google/genai` SDK. Updated `src/agent.ts` transport layer to `GoogleGenAI().models.generateContent(...)` with multimodal contents and `systemInstruction`, preserved existing prompt + JSON parse/validation/retry behavior, and added candidate-part fallback text extraction when `response.text` is absent. Switched UI key source to `VITE_GEMINI_API_KEY` in `src/ui.ts`. Reworked `tests/agent.test.ts` to mock `@google/genai` instead of `fetch` and assert Gemini request shape/config. Updated provider/env-var documentation in `README.md`, `AGENTS.md`, and `TODO.md`. Added dependency `@google/genai` to project dependencies. Validation: `npm run build` passes and `npm test` passes (68/68).
[2026-02-28] [AGENT] [OBSERVABILITY] — Added verbose logging across the full edit pipeline to aid terminal/browser debugging. `src/ui.ts` now logs command start, context readiness, payload sizes, operation summaries, busy/status transitions, undo triggers, and toast events. `src/agent.ts` now logs request attempt metadata (model/hasImage/prompt size), response metadata (candidate/text sizes), text extraction path (direct vs candidate fallback), parse candidate counts, parse failures, and per-operation validation summaries. `src/executor.ts` now logs operation-level and shape-level application details plus parent resolution and undo history transitions. Validation after logging changes: `npm run build` and `npm test` both pass (68/68).
[2026-02-28] [AGENT] [T12,T13,T14-MVP] — Implemented deterministic delete->save->reinsert flow with full sidebar library. Added new `src/asset-library.ts` providing deterministic pre-edit extraction from executed delete SDF regions (`SPHERE`/`ELLIPSOID`/`BOX`), contamination guards (min opacity + color-distance filtering), centroid normalization into `PackedSplats`, in-memory asset registry APIs (`addAsset`, `listAssets`, `getAssetById`), and `createPlacedAssetMesh` for click placement (`maxSh=0`, quaternion fix applied). Updated `src/executor.ts` with `setAssetExtractionHandler(...)` and pre-application delete hook invocation so extraction snapshots happen before visual deletion. Updated `src/main.ts` to register extraction handler, save extracted assets, and inject library/placement deps into UI. Expanded `src/ui.ts` to include right-side asset library panel, selection + placement mode (next splat click places selected asset), library refresh after command execution, and placement toasts/status. Updated `src/styles.css` for sidebar styling/responsive layout. Added `tests/asset-library.test.ts` covering deterministic shape inclusion, centroid normalization/bounds, in-memory library APIs, and placement mesh defaults. Validation: `npm run build` passes; `npm test` passes (72/72).
[2026-02-28] [AGENT] [LOCAL-SELECTION-RESTORE] — Reintroduced the high-impact local targeting path from `khaled/modify_contiguous_grab` into `khaled/add_object_insertion` while intentionally excluding floor-quantile filtering and ellipsoid-fitting behavior. Added `src/click-selection.ts` (click-seeded BFS over face-neighbor cells using color-distance gating, confidence score, deterministic cluster bounds/center, and BOX recommendation hint text). Updated `src/viewer.ts` with `getScreenshotCropAroundPoint(point, sizePx=320)` for click-centered crop capture. Updated `src/agent.ts` with optional secondary screenshot plumbing (`setSecondaryScreenshotForNextCommand`) and dual-image Gemini request assembly plus prompt instruction that second image is the click crop. Updated `src/ui.ts` to pass crop image + selection hints (feature-flagged via `VITE_ENABLE_CLICK_SELECTION_HINTS`, confidence gate at `0.35`) while keeping sidebar asset insertion flow unchanged. Updated `src/main.ts` to inject `getScreenshotCropAroundPoint` into UI deps. Added `tests/click-selection.test.ts` (null seed handling, gated cluster growth, hint formatting). Validation: `npm run build` passes and `npm test` passes (75/75).
[2026-02-28] [AGENT] [INPUT-FOCUS-MOVEMENT] — Updated `src/viewer.ts` keyboard movement handling so WASD/QE movement is ignored while typing in chat/UI inputs. Added an editable-target guard for `keydown` events (`input`, `textarea`, `select`, and contenteditable), and clear active movement keys on `focusin` when entering text fields to avoid carry-over drift. Validation: `npm run build` passes and `npm test` passes (75/75).
[2026-02-28] [AGENT] [LLM-FAILOVER] — Added provider failover in `src/agent.ts`: primary Gemini (`gemini-3-flash-preview`) now falls back to OpenAI Responses API when Gemini has transient failures (e.g., 503 high demand / unavailable, rate-limit/network-style failures), using `VITE_OPENAI_API_KEY` and model default `gpt-5.2` (override with `VITE_OPENAI_MODEL`). Implemented OpenAI multimodal request assembly (full image + optional crop image + text), robust response text extraction (`output_text` and message content fallback), and error parsing for non-2xx responses. Non-transient Gemini output/schema failures do not trigger fallback. Added `tests/agent.test.ts` coverage for Gemini->OpenAI failover. Validation: `npm test` passes (76/76) and `npm run build` passes.
[2026-02-28] [AGENT] [ASSET-CAPTURE-HARDEN] — Fixed missing post-delete library entries in practical scenes by relaxing and widening deterministic extraction. In `src/asset-library.ts`: reduced minimum extracted-splat threshold from 24 to 8, added extraction support for `CYLINDER` and `CAPSULE` shapes (in addition to `SPHERE`/`ELLIPSOID`/`BOX`), and improved skip diagnostics (unsupported shape list + min threshold in logs). In `src/ui.ts`: added explicit user feedback when delete succeeds but asset capture is empty. In `tests/asset-library.test.ts`: added coverage for cylinder/capsule inclusion. Validation: `npm run build` passes and `npm test` passes (77/77).
[2026-02-28] [AGENT] [PRELOADED-ASSETS] — Added manifest-driven preloaded asset seeding for library startup. `src/asset-library.ts` now loads `/scenes/preloaded-assets/index.json` and seeds all listed `.spz` assets as builtin library entries (ordered first), with fallback to legacy butterfly path if manifest is missing. Added `public/scenes/preloaded-assets/index.json` default manifest containing butterfly. `src/main.ts` continues to call `ensureDefaultLibraryAsset()` (now loads all preloaded entries). Validation: `npm run build` passes and `npm test` passes (78/78).
[2026-02-28] [AGENT] [DELETE-REGRESSION-FIX] — Fixed deletion targeting drift caused by coordinate-frame mismatch. Updated `src/spatial-index.ts` to build the voxel grid in true world space by transforming local splat centers and local bounds through `splatMesh.matrixWorld` (with `updateMatrixWorld(true)`), including world-space min/max accumulators and new diagnostics logs (`[spatial] Grid worldBounds`, sample cell center). Hardened `src/executor.ts` to always pass boolean `invert` to Spark (`op.invert === true ? true : false`) and updated `src/agent.ts` delete normalization to force `invert=false`. Improved `src/click-selection.ts` shape suggestion quality with aspect-ratio fitting (`SPHERE`/`ELLIPSOID`/`BOX`) and shape-specific hint formatting plus softer guidance language. Added a regression unit test for world-bounds transformation in `tests/spatial-index.test.ts`. Validation: `npm run build` passes and `npm test` passes (80/80).
[2026-02-28] [AGENT] [SELECTION-RETUNE] — Applied targeted post-fix selection tuning (no rollback): raised `MIN_SELECTION_CONFIDENCE` in `src/ui.ts` from `0.15` to `0.25` to reduce low-quality hint injection, and reduced `boxPadding` in `src/click-selection.ts` from `1.18` to `1.10` to tighten suggested delete/recolor bounds. Validation: `npm run build` passes and `npm test` passes (80/80).
[2026-02-28] [AGENT] [SELECTION-BSEARCH] — Applied midpoint retune after “removing too little” feedback: set `MIN_SELECTION_CONFIDENCE` to `0.20` (between `0.15` and `0.25`) and `boxPadding` to `1.14` (between `1.18` and `1.10`). Validation: `npm run build` passes and `npm test` passes (80/80).
[2026-02-28] [AGENT] [MULTI-WORLD-HUB] — Implemented multi-world runtime and hub UX with cross-world asset reuse. Added `src/world-catalog.ts` + `public/scenes/worlds.json` for curated world manifest loading/validation with fallback. Extended `src/viewer.ts` with hot-swap APIs (`loadWorld`, `disposeCurrentWorld`, `getCurrentSplatMesh`) to replace active `SplatMesh` without recreating renderer/camera/listeners. Refactored `src/main.ts` to catalog-driven world lifecycle (`loadWorldById`), world-scoped source metadata for extraction, and UI world deps wiring. Rebuilt `src/ui.ts` to include full-screen world hub overlay (`Esc` toggle, node-map + list, async world loading guard) while keeping chat, provider toggle, undo, and persistent asset library. Added `tests/world-catalog.test.ts` and updated styles/docs (`src/styles.css`, `README.md`, `AGENTS.md`).
